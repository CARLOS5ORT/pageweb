<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Voice Master Pro - IA Real Time</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.sound.min.js"></script>
<script src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"></script>

<style>
body {
    margin: 0;
    background: #050508;
    color: #00f2ff;
    font-family: 'Segoe UI', sans-serif;
    overflow: hidden;
}
#setup-panel {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(20,20,40,0.95);
    padding: 40px;
    border: 2px solid #00f2ff;
    border-radius: 20px;
    text-align: center;
    z-index: 100;
    width: 320px;
}
#footer-controls {
    position: absolute;
    bottom: 0;
    width: 100%;
    background: rgba(0,0,0,0.95);
    border-top: 1px solid #333;
    padding: 10px 0 25px 0;
}
.hidden { display: none; }
#progress-container {
    width: 90%;
    height: 12px;
    background: #222;
    margin: 10px auto;
    border-radius: 6px;
    cursor: pointer;
}
#progress-bar {
    width: 0%;
    height: 100%;
    background: #00f2ff;
}
#controls-row {
    display: flex;
    justify-content: center;
    gap: 12px;
}
.btn-ctrl {
    background: transparent;
    border: 1px solid #00f2ff;
    color: #00f2ff;
    padding: 8px 18px;
    border-radius: 20px;
    font-size: 11px;
    cursor: pointer;
}
.btn-ctrl:hover { background: #00f2ff; color: #000; }
.btn-stop { border-color: #ff4444; color: #ff4444; }
.btn-change { border-color: #ffaa00; color: #ffaa00; }
#hud {
    position: absolute;
    top: 20px;
    right: 20px;
    text-align: right;
}
#lyricsEditor {
    position:absolute;
    top:20px;
    left:20px;
    width:320px;
    height:240px;
    display:none;
    background:#000;
    color:#0ff;
}
</style>
</head>

<body>

<div id="setup-panel">
    <h1>VOICE MASTER</h1>
    <p>Análisis de tono en tiempo real</p>
    <input type="file" id="audioFile" accept="audio/*"><br><br>
    <input type="file" id="lrcFile" accept=".lrc"><br><br>
    <button class="btn-ctrl" onclick="iniciarTodo()" style="background:#00f2ff;color:#000">
        CARGAR Y ANALIZAR
    </button>
</div>

<div id="footer-controls" class="hidden">
    <div id="progress-container" onclick="clickBarra(event)">
        <div id="progress-bar"></div>
    </div>
    <div id="controls-row">
        <button class="btn-ctrl btn-change" onclick="cambiarCancion()">Nueva</button>
        <button class="btn-ctrl" onclick="saltar(-10)">-10s</button>
        <button class="btn-ctrl" id="playBtn" onclick="togglePlay()">PAUSA</button>
        <button class="btn-ctrl btn-stop" onclick="detener()">STOP</button>
        <button class="btn-ctrl" onclick="saltar(10)">+10s</button>
        <div id="time" style="width:120px;color:#888;font-family:monospace">0 / 0</div>
    </div>
</div>

<div id="hud" class="hidden">
    <div id="note" style="font-size:60px;color:#ff00ff">--</div>
    <div id="score">AFINACIÓN</div>
</div>

<textarea id="lyricsEditor"></textarea>

<script>
let song, mic, pitchUser, fftSong;
let bars = [];
let voiceTrail = [];
let freqUser = 0;
let ready = false;

const notes = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

let lyrics = [];

function setup() {
    createCanvas(windowWidth, windowHeight);
}

async function iniciarTodo() {
    let file = document.getElementById('audioFile').files[0];
    if (!file) return;

    document.getElementById('setup-panel').classList.add('hidden');
    document.getElementById('footer-controls').classList.remove('hidden');
    document.getElementById('hud').classList.remove('hidden');

    await getAudioContext().resume();

    song = loadSound(URL.createObjectURL(file), () => {
        fftSong = new p5.FFT(0.9, 2048);
        fftSong.setInput(song);

        mic = new p5.AudioIn();
        mic.start(() => {
            const modelURL =
            'https://raw.githubusercontent.com/ml5js/ml5-data-and-models/main/models/pitch-detection/crepe/';
            pitchUser = ml5.pitchDetection(modelURL, getAudioContext(), mic.stream, () => {
                ready = true;
                song.play();
            });
        });
    });
}

function draw() {
    background(5,5,15);
    if (!ready) return;

    drawGrid();

    let now = song.currentTime();
    let fSong = detectPitchSong();
    let lyric = getActiveLyric(now);

    if (fSong && fSong > 80 && fSong < 1100) {
        if (bars.length === 0 || now - bars[bars.length-1].time > 0.15) {
            bars.push({ y: freqToY(fSong), time: now });
        }
    }

    pitchUser.getPitch((e,f)=> freqUser = f || 0);

    for (let b of bars) {
        let x = width/2 + (b.time - now) * 250;
        if (x < 80 || x > width) continue;

        strokeWeight(10);
        stroke("#ff00ff");
        line(x, b.y, x+45, b.y);

        if (lyric && Math.abs(b.time - lyric.time) < 0.2) {
            drawLyrics(lyric, now, x, b.y - 30, fSong);
        }
    }

    if (freqUser > 0) {
        let y = freqToY(freqUser);
        voiceTrail.push({ y, time: now });

        let midi = Math.round(12 * Math.log2(freqUser / 440) + 69);
        document.getElementById('note').innerText =
            notes[midi % 12] + (Math.floor(midi / 12) - 1);
    } else {
        document.getElementById('note').innerText = "--";
    }

    drawVoiceTrail(now);
    updateUI();
}

function drawVoiceTrail(now) {
    stroke("#00ff96");
    strokeWeight(7);
    noFill();
    beginShape();
    for (let v of voiceTrail) {
        let x = width/2 + (v.time - now) * 250;
        if (x < 80 || x > width) continue;
        vertex(x, v.y);
    }
    endShape();
    voiceTrail = voiceTrail.filter(v => now - v.time < 3);
}

function detectPitchSong() {
    let w = fftSong.waveform();
    let best = -1, bestCorr = 0;
    for (let o=20;o<1000;o++) {
        let c=0;
        for (let i=0;i<w.length-o;i++) c+=w[i]*w[i+o];
        if (c>bestCorr) { bestCorr=c; best=o; }
    }
    return best>0 ? getAudioContext().sampleRate/best : null;
}

function drawGrid() {
    for (let i=36;i<84;i++) {
        let f=440*Math.pow(2,(i-69)/12);
        let y=freqToY(f);
        stroke(255,10); line(80,y,width,y);
        noStroke(); fill(0,242,255,120);
        text(notes[i%12]+(floor(i/12)-1),25,y);
    }
}

function freqToY(f) {
    return map(Math.log(f), Math.log(80), Math.log(1100), height-160, 50);
}

function updateUI() {
    let c=song.currentTime(), d=song.duration();
    document.getElementById('progress-bar').style.width = (c/d*100)+"%";
    document.getElementById('time').innerText = floor(c)+" / "+floor(d);
}

function togglePlay() {
    if (song.isPlaying()) { song.pause(); playBtn.innerText="PLAY"; }
    else { song.play(); playBtn.innerText="PAUSA"; }
}

function saltar(s) {
    song.jump(constrain(song.currentTime()+s,0,song.duration()));
}

function detener() {
    song.stop();
    bars=[];
    voiceTrail=[];
}

function cambiarCancion() {
    location.reload();
}

function clickBarra(e) {
    let r=e.target.getBoundingClientRect();
    song.jump((e.clientX-r.left)/r.width*song.duration());
}

function windowResized() {
    resizeCanvas(windowWidth, windowHeight);
}

function getActiveLyric(now) {
    for (let i = lyrics.length - 1; i >= 0; i--) {
        if (now >= lyrics[i].time) return lyrics[i];
    }
    return null;
}

function drawLyrics(lyric, now, x, y, fSong) {
    textSize(18);
    noStroke();
    let offset = 0;
    for (let w of lyric.words) {
        let col = "#888";
        if (now >= w.t) {
            let cents = freqUser && fSong ? 1200*Math.log2(freqUser/fSong) : 0;
            col = Math.abs(cents)<30 ? "#00ff96" : (cents>0?"#4488ff":"#ff4444");
        }
        fill(col);
        text(w.text, x + offset, y);
        offset += textWidth(w.text + " ");
    }
}

document.getElementById("lrcFile").addEventListener("change", e => {
    let r = new FileReader();
    r.onload = () => parseLRC(r.result);
    r.readAsText(e.target.files[0]);
});

function parseLRC(text) {
    lyrics=[];
    for (let line of text.split("\n")) {
        let m=line.match(/\[(\d+):(\d+\.?\d*)\](.*)/);
        if(!m)continue;
        let t=+m[1]*60+parseFloat(m[2]);
        let words=m[3].trim().split(" ").map((w,i)=>({t:t+i*0.25,text:w}));
        lyrics.push({time:t,words});
    }
}

function keyPressed() {
    if (key === 'L') {
        let ed=document.getElementById("lyricsEditor");
        ed.style.display=ed.style.display==="none"?"block":"none";
        ed.value=JSON.stringify(lyrics,null,2);
    }
}
</script>
</body>
</html>
