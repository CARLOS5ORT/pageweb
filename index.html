<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Voice Master Pro - IA Real Time</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.sound.min.js"></script>
<script src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"></script>

<style>
body {
    margin: 0;
    background: #050508;
    color: #00f2ff;
    font-family: 'Segoe UI', sans-serif;
    overflow: hidden;
}
#setup-panel {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(20,20,40,0.95);
    padding: 40px;
    border: 2px solid #00f2ff;
    border-radius: 20px;
    text-align: center;
    z-index: 100;
    width: 320px;
}
#footer-controls {
    position: absolute;
    bottom: 0;
    width: 100%;
    background: rgba(0,0,0,0.95);
    border-top: 1px solid #333;
    padding: 10px 0 25px 0;
}
.hidden { display: none; }
#progress-container {
    width: 90%;
    height: 12px;
    background: #222;
    margin: 10px auto;
    border-radius: 6px;
    cursor: pointer;
}
#progress-bar {
    width: 0%;
    height: 100%;
    background: #00f2ff;
}
#controls-row {
    display: flex;
    justify-content: center;
    gap: 12px;
}
.btn-ctrl {
    background: transparent;
    border: 1px solid #00f2ff;
    color: #00f2ff;
    padding: 8px 18px;
    border-radius: 20px;
    font-size: 11px;
    cursor: pointer;
}
.btn-ctrl:hover { background: #00f2ff; color: #000; }
.btn-stop { border-color: #ff4444; color: #ff4444; }
.btn-change { border-color: #ffaa00; color: #ffaa00; }
#hud {
    position: absolute;
    top: 20px;
    right: 20px;
    text-align: right;
}
</style>
</head>

<body>

<div id="setup-panel">
    <h1>VOICE MASTER</h1>
    <p>Análisis de tono en tiempo real</p>
    <input type="file" id="audioFile" accept="audio/*"><br><br>
    <button class="btn-ctrl" onclick="iniciarTodo()" style="background:#00f2ff;color:#000">
        CARGAR Y ANALIZAR
    </button>
</div>

<div id="footer-controls" class="hidden">
    <div id="progress-container" onclick="clickBarra(event)">
        <div id="progress-bar"></div>
    </div>
    <div id="controls-row">
        <button class="btn-ctrl btn-change" onclick="cambiarCancion()">Nueva</button>
        <button class="btn-ctrl" onclick="saltar(-10)">-10s</button>
        <button class="btn-ctrl" id="playBtn" onclick="togglePlay()">PAUSA</button>
        <button class="btn-ctrl btn-stop" onclick="detener()">STOP</button>
        <button class="btn-ctrl" onclick="saltar(10)">+10s</button>
        <div id="time" style="width:120px;color:#888;font-family:monospace">0 / 0</div>
    </div>
</div>

<div id="hud" class="hidden">
    <div id="note" style="font-size:60px;color:#00ff96">--</div>
    <div id="score">AFINACIÓN: 0%</div>
</div>

<script>
let song, mic, pitchUser, fftSong, amp;
let bars = [];
let trails = [[]];
let freqUser = 0, smoothFreq = 0;
let ready = false;
let totalFrames = 0, tunedFrames = 0;
const alpha = 0.25;
const TOL = 40;

const notes=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

function setup(){ createCanvas(windowWidth, windowHeight); }

async function iniciarTodo(){
    let file=document.getElementById('audioFile').files[0];
    if(!file)return;

    document.getElementById('setup-panel').classList.add('hidden');
    document.getElementById('footer-controls').classList.remove('hidden');
    document.getElementById('hud').classList.remove('hidden');

    await getAudioContext().resume();

    song=loadSound(URL.createObjectURL(file),()=>{
        fftSong=new p5.FFT(0.9,2048);
        fftSong.setInput(song);

        mic=new p5.AudioIn();
        mic.start(()=>{
            amp=new p5.Amplitude();
            amp.setInput(mic);

            const modelURL='https://raw.githubusercontent.com/ml5js/ml5-data-and-models/main/models/pitch-detection/crepe/';
            pitchUser=ml5.pitchDetection(modelURL,getAudioContext(),mic.stream,()=>{
                ready=true; song.play();
            });
        });
    });
}

function draw(){
    background(5,5,15);
    if(!ready)return;

    drawGrid();
    let now=song.currentTime();
    let fSong=detectPitchSong();

    if(fSong && now-(bars.at(-1)?.time||0)>0.2){
        bars.push({y:freqToY(fSong),time:now,freq:fSong});
    }

    pitchUser.getPitch((e,f)=>{
        if(amp.getLevel()<0.02){
            if(trails.at(-1).length>0) trails.push([]);
            freqUser=0; return;
        }
        smoothFreq=alpha*(f||0)+(1-alpha)*smoothFreq;
        freqUser=smoothFreq;
    });

    // Banda de afinación
    if(fSong){
        let y=freqToY(fSong);
        let y1=freqToY(fSong*Math.pow(2,TOL/1200));
        let y2=freqToY(fSong*Math.pow(2,-TOL/1200));
        noStroke(); fill(0,255,150,40);
        rect(80,min(y1,y2),width,min(abs(y1-y2),height));
    }

    // Barras referencia
    stroke("#ff00ff"); strokeWeight(10);
    for(let b of bars){
        let x=width/2+(b.time-now)*250;
        if(x<80||x>width)continue;
        line(x,b.y,x+45,b.y);
    }

    // Voz
    if(freqUser>0){
        let y=freqToY(freqUser);
        let cents=fSong?1200*Math.log2(freqUser/fSong):0;
        totalFrames++; if(Math.abs(cents)<TOL)tunedFrames++;

        let col=cents<-TOL?"#ff4444":cents>TOL?"#4488ff":"#00ff96";
        trails.at(-1).push({y:y,time:now,color:col});

        let midi=Math.round(12*Math.log2(freqUser/440)+69);
        document.getElementById('note').innerText=notes[midi%12]+(Math.floor(midi/12)-1);
    } else document.getElementById('note').innerText="--";

    // Dibujar estelas
    for(let t of trails){
        beginShape(); noFill();
        for(let p of t){
            let x=width/2+(p.time-now)*250;
            if(x<80||x>width)continue;
            stroke(p.color); strokeWeight(8);
            vertex(x,p.y);
        }
        endShape();
    }

    trails=trails.map(t=>t.filter(p=>now-p.time<4));
    updateUI();
}

function detectPitchSong(){
    let w=fftSong.waveform(),best=-1,max=0;
    for(let o=20;o<1000;o++){
        let c=0; for(let i=0;i<w.length-o;i++)c+=w[i]*w[i+o];
        if(c>max){max=c;best=o;}
    }
    return best>0?getAudioContext().sampleRate/best:null;
}

function drawGrid(){
    for(let i=36;i<84;i++){
        let f=440*Math.pow(2,(i-69)/12);
        let y=freqToY(f);
        stroke(255,10); line(80,y,width,y);
        noStroke(); fill(0,242,255,120);
        text(notes[i%12]+(Math.floor(i/12)-1),25,y);
    }
    stroke(0,242,255,40); line(80,0,80,height);
}

function freqToY(f){
    return map(Math.log(f),Math.log(80),Math.log(1100),height-160,50);
}

function updateUI(){
    let c=song.currentTime(),d=song.duration();
    document.getElementById('progress-bar').style.width=(c/d*100)+"%";
    document.getElementById('time').innerText=floor(c)+" / "+floor(d);
    document.getElementById('score').innerText="AFINACIÓN: "+Math.round(tunedFrames/Math.max(1,totalFrames)*100)+"%";
}

function togglePlay(){song.isPlaying()?(song.pause(),playBtn.innerText="PLAY"):(song.play(),playBtn.innerText="PAUSA");}
function saltar(s){song.jump(constrain(song.currentTime()+s,0,song.duration()));}
function detener(){song.stop();bars=[];trails=[[]];totalFrames=tunedFrames=0;}
function cambiarCancion(){detener();location.reload();}
function clickBarra(e){let r=e.target.getBoundingClientRect();song.jump((e.clientX-r.left)/r.width*song.duration());}
function windowResized(){resizeCanvas(windowWidth,windowHeight);}
function keyPressed(){ if(key==='s'||key==='S') saveCanvas('voice_master','png'); }
</script>
</body>
</html>
